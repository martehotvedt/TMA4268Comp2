---
title: "Compulsory Exercise 2: Age Prediction for Heart Failure"
author:
- "Karianne Strand Bergem"
- "Marte Ragnhild Hotvedt"
- "Erlend Winje"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: \usepackage{amsmath}
output:
  # html_document:
  #   toc: no
  #   toc_depth: '2'
  #   df_print: paged
  pdf_document:
    toc: no
    toc_depth: '2'
urlcolor: blue
abstract: "This is the place for your abstract (max 350 words)"
---
  
```{r setup, include=FALSE}
library(knitr)
# Feel free to change the setting as you see fit
knitr::opts_chunk$set(echo = TRUE,
                      tidy = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      strip.white = TRUE,
                      prompt = FALSE,
                      cache = TRUE,
                      size = "scriptsize",
                      fig.width = 4,
                      fig.height = 3,
                      fig.align = "center")

```

```{r, eval=TRUE, echo=FALSE}
library("knitr")
library("rmarkdown")
```

<!--  Etc (load all packages needed). -->

## Abstract


## Introduction: Scope and purpose of your project
Problemstillingen vår kan være om vi kan predikere alder basert på de variablene i Heart Failure-datasettet? Er det vi skal finne ut av liksom


## Descriptive data analysis/statistics
```{r}
data <- read.csv("heart.csv")
```



## Methods
```{r, eval=TRUE, echo=TRUE}
n <- nrow(data) # Number of observations

# Indexes for the training set (70% of the data)
train_idx <- sample(1:n, size = round(0.7 * n), replace = FALSE)

# Split the data
train_data <- data[train_idx, ]
test_data <- data[-train_idx, ]
```

# Multiple linear regression

In this section, we will consider Multiple Linear Regression (MLR) as a method to predict age for the heart failure data set. This choice of method was due to the fact that MLR is easy to interpret. We assume that 

$$\mathbf{Y} = \mathbf{X}\beta + \epsilon,$$
where $\mathbf{Y}$ is a $(918 \times 1)$ vector of responses (age), $\beta$ is a $(16 \times 1)$ of regression parameters, and $\epsilon$ is a $(918 \times 1)$ vector of random errors. $\mathbf{X}$ is the $(918 \times 16)$ design matrix given by

\begin{equation*}
\mathbf{X} = \begin{bmatrix}
1 & x_{1,1} & \dots & x_{1, 11} \\
1 & x_{2,1} & \dots & x_{2, 11} \\
\vdots & \dots & \dots & \vdots \\
1 & x_{918,1} & \dots & x_{918, 11} \\
\end{bmatrix},
\end{equation*}

where row $i$ contains a $(16 \times 1)$ vector $x^T_i$ for observation $i$. The design matrix has full rank. In addition, since the number of rows is $n = 918$ and of columns is $(p+1) = 16$, the model assumption $n >> (p+1)$ holds. We assume that $\epsilon \sim N_{918}(0, \sigma^2\mathbf{I})$.

The regression is done by the $\texttt{lm()}$-function:

```{r, eval = TRUE, echo = TRUE}
mlr_mod <- lm(Age ~ ., data = train_data)
summary(mlr_mod)
```

To get an idea of which the predictors $X_1, \dots, X_n$ is useful in predicting the response, we check if we could as well omit all predictor variables at the same time. We formulate the test as 

\begin{align*}
H_0: \beta_1 = \beta_2 & = \dots = \beta_p = 0  \\
&\text{vs.} \\
H_1: \text{at least one } & \beta_j \text{ is non-zero.} 
\end{align*}

# Ridge/Lasso
Apply Ridge regression to the Heart dataset.
```{r, eval=TRUE, echo=TRUE}
library(glmnet)

# Create design matrices
x_train <- model.matrix(Age ~ ., data = train_data)[, -1]
y_train <- train_data$Age
x_test <- model.matrix(Age ~ ., data = test_data)[, -1]
y_test <- test_data$Age

# `alpha=0` is the ridge penalty
ridge_mod <- glmnet(x_train, y_train, alpha = 0)

# Cross-validation to find the best lambda
set.seed(123)
cv_ridge <- cv.glmnet(x_train, y_train, alpha = 0)

plot(cv_ridge)
```
Now, we want to find the best $\lambda$.
```{r, eval=TRUE, echo=TRUE}
best_lambda <- cv_ridge$lambda.min
best_lambda
```
Evaluate the method
```{r, eval=TRUE, echo=TRUE}
ridge_pred <- predict(cv_ridge, s = best_lambda, newx = x_test)
mse <- mean((y_test - ridge_pred)^2)
r2 <- 1 - sum((y_test - ridge_pred)^2) / sum((y_test - mean(y_test))^2)

cat("MSE:", mse, "\n")
cat("R²:", r2, "\n")
```

## Results and interpretation
Evaluere modellene på testsettet.
Sammenligne metodene – hvilken ga best resultater?
Diskutere hvilke variabler som har størst betydning for prediksjon av alder.


## Summary